<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">

<head layout:fragment="head">
    <title>리뷰 폼</title>
    <link th:href="@{/css/bootstrap.min.css}"
          href="/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .form-container {
            max-width: 560px;
            padding-left: 100px;
        }
        .field-error {
            border-color: #dc3545;
            color: #dc3545;
        }
        /*#positiveBuyerIndicator,*/
        /*#negativeBuyerIndicator,*/
        /*#positiveSellerIndicator,*/
        /*#negativeSellerIndicator {*/
        /*    display: none;*/
        /*}*/
        #reviewSellerMessage, #reviewBuyerMessage textarea {
            height: 300px;
            width: 500px;
        }

    </style>
</head>

<div layout:fragment="content">
    <div class="form-container">
        <div class="py-5 text-center">
            <h2>리뷰</h2>
        </div>
        <h4 class="mb-3">리뷰 작성</h4>

        <th:block th:if="${#httpServletRequest.servletPath =='/reviews/seller'}">
            <form id="reviewSeller">
                <input type="hidden" th:name="sellerId" th:value="${reviewForm.sellerId}"/>
                <input type="hidden" th:name="buyerId" th:value="${reviewForm.buyerId}"/>
                <div>
                    <p>구매 후기 남기기</p>
                    <p th:text="|${reviewForm.buyerId}님, |"></p>
                    <p th:text="|${reviewForm.sellerId}님과의 거래가 어땠나요?|"></p>
                </div>

                <label for="sellerReviewState">평가</label>
                <div id="sellerReviewState">
                    <th:block th:each="RSValue:${T(com.exercise.carrotproject.domain.enumList.ReviewState).values()}"  >
                        <button type="button" id="reviewStateBtn" th:text="${RSValue.description}" th:onclick="viewSellerForm([[${RSValue.stateCode}]])"></button>
                    </th:block>
                    <div class="reviewStateCode"></div>
                </div>

                <div id="sellerIndicators">
                    <div id="positiveSellerIndicator">
                        <h5>어떤 점이 좋았나요?</h5>
                        <th:block th:each="RB:${T(com.exercise.carrotproject.domain.enumList.ReviewSellerIndicator).values()}">
                            <label th:if="${RB.name().contains('PS')}">
                                <input type="checkbox" th:name="indicator" th:value="${RB}">
                                [[${RB.description}]]
                            </label>
                        </th:block>
                    </div>
                    <div id="negativeSellerIndicator">
                        <h5>어떤 점이 별로였나요?</h5>
                        <th:block th:each="RB:${T(com.exercise.carrotproject.domain.enumList.ReviewSellerIndicator).values()}">
                            <label th:if="${RB.name().contains('NS')}">
                                <input type="checkbox" th:name="indicator" th:value="${RB}">
                                [[${RB.description}]]
                            </label>
                        </th:block>
                    </div>
                </div>

                <hr class="my-4">
                <div id="reviewSellerMessage"></div>

                <hr class="my-4">
                <div class="row">
                    <div class="col">
                        <button class="w-100 btn btn-secondary btn-lg"
                                onclick="history.go(-1); return false;"
                                type="button">이전으로</button>
                    </div>
                    <div class="col">
                        <button class="w-100 btn btn-secondary btn-lg"
                                type="button"
                                th:onclick="reviewSeller()">리뷰 남기기</button>
                    </div>
                </div>
            </form>
        </th:block>

        <th:block th:if="${#httpServletRequest.servletPath.equals('/reviews/buyer')}">
            <form id="reviewBuyer">
                <input type="hidden" th:name="sellerId" th:value="${reviewForm.sellerId}"/>
                <input type="hidden" th:name="buyerId" th:value="${reviewForm.buyerId}"/>
                <div>
                    <p>판매 후기 남기기</p>
                    <p th:text="|${reviewForm.sellerId}님, |"></p>
                    <p th:text="|${reviewForm.buyerId}님과의 거래가 어땠나요?|"></p>
                </div>

               <label for="buyerReviewState">평가</label>
               <div id="buyerReviewState">
                    <th:block th:each="RSValue:${T(com.exercise.carrotproject.domain.enumList.ReviewState).values()}"  >
                        <button type="button" th:text="${RSValue.description}"
                                th:onclick="t([[${RSValue.stateCode}]])">
                        </button>
                    </th:block>
                   <div class="reviewStateCode"></div>
               </div>

                <div id ="buyerReviewForm">
                   <hr class="my-4">
                </div>

               <hr class="my-4">
               <div class="row">
                   <div class="col">
                       <button class="w-100 btn btn-secondary btn-lg"
                               onclick="history.go(-1); return false;"
                               type="button">이전으로</button>
                   </div>
                   <div class="col">
                       <button class="w-100 btn btn-secondary btn-lg"
                               type="button"
                       th:onclick="reviewBuyer()">리뷰 남기기</button>
                   </div>
               </div>
        </form>
    </th:block>

    </div> <!-- /form-container -->
</div>

<div layout:fragment="script">
    <script th:inline="javascript">
        let reviewStateCode = '0';

        function viewSellerForm(reviewStateNum) {
            const reviewSellerMessage = document.getElementById("reviewSellerMessage");
            const negativeSellerIndicator = document.getElementById("negativeSellerIndicator");
            const positiveSellerIndicator = document.getElementById("positiveSellerIndicator");
            if(reviewStateCode==0) {
                negativeSellerIndicator.style.display= "block";
                positiveSellerIndicator.style.display= "none";
                reviewSellerMessage.innerHTML = `<div id="reviewBuyerMessage">
                    <h5>아쉬웠던 점을 망고마켓 팀에 알려주세요</h5>
                    <p>상대방에게  전달되지 않으니 안심하세요 </p>
                   <textarea  name="message"
                           class="formcontrol" placeholder="여기에 적어주세요. (선택사항)"> </textarea>
                </div>` ;
            } else{
                negativeSellerIndicator.style.display= "none";
                positiveSellerIndicator.style.display= "block";
                reviewSellerMessage.innerHTML = ` <div id="reviewSellerMessage">
                    <h5>따뜻한 거래경험을 알려주세요!</h5>
                    <p>남겨주신 거래후기는 상대방의 프로필에 공개돼요</p>
                    <textarea  th:name="message"
                           class="formcontrol"> 여기에 적어주세요. (선택사항)</textarea>
                </div>` ;
                reviewStateCode = reviewStateNum=='1' ? '1' : '2';
            }
        }

        function viewBuyerForm(reviewStateNum) {
            const buyerReviewForm = document.getElementById("buyerReviewForm");
            if(reviewStateNum == '0') {
                buyerReviewForm.firstElementChild.remove();
                buyerReviewForm.lastElementChild.remove();
                const buyerIndicators = `<div id="buyerIndicators">
                            <h5>어떤 점이 별로였나요?</h5>
                            <th:block th:each="RB:${T(com.exercise.carrotproject.domain.enumList.ReviewBuyerIndicator).values()}">
                                <label th:if="${RB.name().contains('NB')}">
                                    <input type="checkbox" th:name="indicator" th:value="${RB}">
                                    [[${RB.description}]]
                                </label>
                            </th:block>
                            </div>`;
                buyerReviewForm.insertAdjacentHTML("afterbegin", buyerIndicators);
                const message = ` <div id="reviewBuyerMessage">
                    <h5>아쉬웠던 점을 망고마켓 팀에 알려주세요</h5>
                    <p>상대방에게  전달되지 않으니 안심하세요 </p>
                    <textarea  name="message"
                           class="formcontrol"> 여기에 적어주세요. (선택사항)</textarea>
                </div>`;
                buyerReviewForm.insertAdjacentHTML("beforeend", message);
            } else {
                reviewStateCode = reviewStateNum=='1' ? '1' : '2';
                buyerReviewForm.firstElementChild.remove();
                buyerReviewForm.lastElementChild.remove();
                const buyerIndicators = `<div id="buyerIndicators">
                            <h5>어떤 점이 좋았나요?</h5>
                            <th:block th:each="RB:${T(com.exercise.carrotproject.domain.enumList.ReviewBuyerIndicator).values()}">
                               <label th:if="${RB.name().contains('PB')}">
                                   <input type="checkbox" th:name="indicator" th:value="${RB}">
                                   [[${RB.description}]]
                               </label>
                            </th:block>
                            </div>`;
                buyerReviewForm.insertAdjacentHTML("afterbegin", buyerIndicators);
                const message = `<div id="reviewBuyerMessage">
                    <h5>따뜻한 거래경험을 알려주세요!</h5>
                    <p>남겨주신 거래후기는 상대방의 프로필에 공개돼요</p>
                    <textarea  th:name="message"
                           class="formcontrol"> 여기에 적어주세요. (선택사항)</textarea>
                </div>`
                buyerReviewForm.insertAdjacentHTML("beforeend", message);
            }
        }


        function reviewSeller() {
            const formData =  new FormData($("#reviewSeller")[0]);
      /*      $.ajax({
                type: 'post',
                url: '/updatePfImg',
                enctype: 'multipart/form-data',
                data: formData,
                processData: false,
                contentType: false,
                cache: false,
                async: false,
                success: function (data) {
                    alert("프로필 이미지가 변경되었습니다.");

                },
                error: function (err) {
                    console.log(err);
                    alert("이미지를 변경을 할 수 없습니다.");
                }
            })*/
        }

        function reviewBuyer() {
            isCheckedBox();
            const formData =  new FormData($("#reviewBuyer")[0]);
            formData.append('reviewStateCode', reviewStateCode);
            console.log(formData.get("reviewStateCode"));
            appendCheckList(formData)
            console.log("상위 --- "+formData.get("indicators"))
            $.ajax({
                type: 'post',
                url: '/reviews/buyer',
                data: JSON.stringify(formData),
                //contentType: false,
                //processData: false,
                success: function (data) {
                    alert("프로필 이미지가 변경되었습니다.");
                },
                error: function (err) {
                    console.log(err);
                    alert("이미지를 변경을 할 수 없습니다.");
                }
            })
        }

        function isCheckedBox() {
            if ($('input:checkbox[name="indicator"]:checked').length == 0) {
                alert("최소 1개 이상의 지표에 체크해주세요");
                throw new Error();
            }
        }
        function appendCheckList(formData) {
            const allCheckbox = $('input:checkbox[name="indicator"]');
            allCheckbox.each(function() {
                console.log(allCheckbox.is(":checked"));
                if (allCheckbox.is(":checked")){
                    formData.append('indicators', this.value);
                }
            });
            console.log("indicators",formData.get("indicators"));
        }

    </script>
</div>